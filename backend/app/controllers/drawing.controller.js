const db = require("../models")
// const Whiteboard = db.whiteboard
// const User = db.user
const Drawing = db.drawing



const data = {
    "id": 2,
    "x1": 422,
    "y1": 393,
    "x2": 620,
    "y2": 611,
    "type": "circle",
    "roughElement": {
        "shape": "circle",
        "sets": [
            {
                "type": "path",
                "ops": [
                    {
                        "op": "move",
                        "data": [
                            377.7122802147425,
                            106.90316326758841
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            397.2610264890693,
                            99.0643539220423,
                            421.31846278054775,
                            102.0032868053736,
                            443.21753858971005,
                            103.43987164294828
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            465.11661439887234,
                            104.87645648052295,
                            488.35891954526744,
                            108.964374445707,
                            509.10673506971636,
                            115.52267229303641
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            529.8545505941653,
                            122.08097014036582,
                            548.9748009970841,
                            131.3624746103663,
                            567.7044317364034,
                            142.78965872692476
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            586.4340624757227,
                            154.21684284348322,
                            605.6204469371281,
                            168.81712873507928,
                            621.4845195056323,
                            184.0857769923871
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            637.3485920741365,
                            199.35442524969494,
                            650.9255138715611,
                            216.1203915355493,
                            662.8888671474283,
                            234.40154827077166
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            674.8522204232955,
                            252.68270500599402,
                            685.6553228671538,
                            272.96891043616716,
                            693.2646391608357,
                            293.77271740372134
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            700.8739554545176,
                            314.5765243712755,
                            706.1886210956444,
                            337.4559394486143,
                            708.5447649095195,
                            359.2243900760967
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            710.9009087233945,
                            380.99284070357913,
                            710.0269778454219,
                            402.4834801495699,
                            707.4015020440863,
                            424.38342116861577
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            704.7760262427507,
                            446.2833621876616,
                            699.9566060152187,
                            469.6815511383708,
                            692.7919101015057,
                            490.62403619037195
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            685.6272141877927,
                            511.5665212423731,
                            676.0499366082502,
                            531.7249119368815,
                            664.4133265618083,
                            550.0383314806224
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            652.7767165153664,
                            568.3517510243634,
                            638.6312434037948,
                            585.270088195899,
                            622.972249822854,
                            600.5045534528176
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            607.3132562419132,
                            615.7390187097362,
                            589.1717370413406,
                            630.0968727304139,
                            570.4593650761634,
                            641.4451230221341
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            551.7469931109862,
                            652.7933733138543,
                            531.4886725916436,
                            661.6800438340292,
                            510.6980180317908,
                            668.5940552031391
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            489.907363471938,
                            675.5080665722489,
                            467.57633138865,
                            680.9736212584428,
                            445.7154377170466,
                            682.9291912367929
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            423.8545440454432,
                            684.884761215143,
                            401.01996372180827,
                            683.6845039203002,
                            379.5326560021705,
                            680.3274750732398
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            358.0453482825327,
                            676.9704462261794,
                            336.8662884598078,
                            670.9224817148971,
                            316.7915913992198,
                            662.7870181544304
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            296.7168943386318,
                            654.6515545939636,
                            277.1581841890106,
                            643.939106560831,
                            259.08447363864263,
                            631.5146937104396
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            241.01076308827462,
                            619.0902808600482,
                            223.0206580643598,
                            604.4104225214664,
                            208.3493280970117,
                            588.2405410520819
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            193.6779981296636,
                            572.0706595826973,
                            181.56658135080858,
                            553.7012181516544,
                            171.05649383455398,
                            534.495404894132
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            160.54640631829938,
                            515.2895916366095,
                            151.49738832188154,
                            494.2497940381413,
                            145.288802999484,
                            473.00566150694704
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            139.08021767708647,
                            451.76152897575275,
                            134.96264223544298,
                            429.2614263643469,
                            133.80498190016874,
                            407.0306097069661
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            132.6473215648945,
                            384.79979304958533,
                            134.28265539835036,
                            361.21428679990976,
                            138.34284098783854,
                            339.6207615626623
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            142.40302657732673,
                            318.0272363254149,
                            149.1874928263648,
                            297.6919294663439,
                            158.1660954370978,
                            277.4694582834816
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            167.1446980478308,
                            257.24698710061926,
                            179.2029633501031,
                            236.0772777613344,
                            192.21445665223644,
                            218.28593446548842
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            205.22594995436978,
                            200.49459116964246,
                            219.7949398087529,
                            184.85527160212902,
                            236.2350552498978,
                            170.72139850840574
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            252.67517069104272,
                            156.58752541468246,
                            271.2876018427616,
                            143.32145963354887,
                            290.85514929910596,
                            133.4826959031488
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            310.4226967554503,
                            123.64393217274873,
                            334.60880578288584,
                            116.856674412073,
                            353.64033998796384,
                            111.68881612600535
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            372.67187419304184,
                            106.5209578399377,
                            392.0464038211897,
                            102.90384549154628,
                            405.0443545295739,
                            102.47554618674286
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            418.04230523795815,
                            102.04724688193944,
                            431.30429272832885,
                            104.13913471677344,
                            431.6280442382692,
                            109.11902029718482
                        ]
                    },
                    {
                        "op": "move",
                        "data": [
                            284.4672944446193,
                            138.37551603997431
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            300.3112490259156,
                            124.44767534976923,
                            323.99977129130025,
                            119.17218921098913,
                            345.01951210447464,
                            113.46345250339476
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            366.03925291764904,
                            107.7547157958004,
                            388.49587431002703,
                            105.20819290078943,
                            410.5857393236657,
                            104.12309579440807
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            432.6756043373043,
                            103.03799868802672,
                            456.2319265040928,
                            102.82895780857116,
                            477.55870218630645,
                            106.95286986510666
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            498.88547786852007,
                            111.07678192164217,
                            518.6647562187803,
                            119.77488871248991,
                            538.5463934169475,
                            128.86656813362106
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            558.4280306151146,
                            137.9582475547522,
                            579.2389653410991,
                            148.1632218476693,
                            596.8485253753096,
                            161.50294639189357
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            614.4580854095201,
                            174.84267093611786,
                            630.4500690423755,
                            191.88219126246346,
                            644.2037536222103,
                            208.9049153989668
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            657.9574382020452,
                            225.92763953547015,
                            669.6289493108347,
                            243.9279016067719,
                            679.3706328543185,
                            263.63929121091365
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            689.1123163978023,
                            283.3506808150554,
                            697.5660419446515,
                            305.80584781212275,
                            702.6538548831128,
                            327.1732530238173
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            707.7416678215741,
                            348.5406582355119,
                            709.9490365336808,
                            369.874547176449,
                            709.8975104850866,
                            391.843722481081
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            709.8459844364925,
                            413.81289778571295,
                            707.3606837418029,
                            437.20075079334583,
                            702.3446985915475,
                            458.98830485160903
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            697.3287134412922,
                            480.7758589098722,
                            689.2888542830891,
                            502.99518606041136,
                            679.8015995835544,
                            522.56904683066
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            670.3143448840198,
                            542.1429076009086,
                            659.2343129535383,
                            559.6637945950355,
                            645.4211703943397,
                            576.4314694731008
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            631.6080278351411,
                            593.1991443511662,
                            614.3790990457189,
                            609.8599982867149,
                            596.922744228363,
                            623.1750960990522
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            579.466389411007,
                            636.4901939113895,
                            560.4883760125848,
                            647.2319376035845,
                            540.6830414902034,
                            656.3220563471245
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            520.8777069678221,
                            665.4121750906646,
                            499.7502752956872,
                            673.2718027302686,
                            478.09073709407465,
                            677.7158085602929
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            456.43119889246213,
                            682.1598143903171,
                            432.8183133730121,
                            683.6231224326699,
                            410.7258122805284,
                            682.9860913272703
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            388.6333111880447,
                            682.3490602218707,
                            366.4805435160196,
                            679.3874870991253,
                            345.5357305391725,
                            673.8936219278953
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            324.5909175623254,
                            668.3997567566653,
                            303.97221353345736,
                            660.5023114781867,
                            285.05693441944555,
                            650.0229002998904
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            266.14165530543374,
                            639.543489121594,
                            248.20407373505705,
                            626.0102889303477,
                            232.04405585510173,
                            611.0171548581171
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            215.8840379751464,
                            596.0240207858866,
                            201.0337483793947,
                            578.0839941751855,
                            188.09682713971367,
                            560.0640958665074
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            175.15990590003264,
                            542.0441975578293,
                            162.98502616198402,
                            523.0567491952432,
                            154.4225284170156,
                            502.89776500604864
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            145.86003067204717,
                            482.73878081685405,
                            139.99708952123495,
                            460.951992007133,
                            136.7218406699032,
                            439.1101907313398
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            133.44659181857145,
                            417.2683894555466,
                            133.0591255756233,
                            393.87379487495605,
                            134.77103530902514,
                            371.8469573512893
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            136.48294504242696,
                            349.82011982762253,
                            140.6350723762132,
                            327.9652342209712,
                            146.9932990703141,
                            306.94916558933943
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            153.351525764415,
                            285.9330969577077,
                            162.00606055009104,
                            264.8702771967537,
                            172.92039547363046,
                            245.75054556149865
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            183.8347303971699,
                            226.6308139262436,
                            197.34960350746945,
                            207.98143111833576,
                            212.4793086115507,
                            192.2307757778092
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            227.60901371563193,
                            176.48012043728266,
                            251.64648363676616,
                            160.2539109537706,
                            263.698626098118,
                            151.24661351833942
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            275.7507685594698,
                            142.23931608290823,
                            280.7080869712027,
                            139.76601754154663,
                            284.7921633796617,
                            138.18699116522217
                        ]
                    },
                    {
                        "op": "bcurveTo",
                        "data": [
                            288.8762397881207,
                            136.6079647888977,
                            286.0443199631511,
                            137.86453446641713,
                            288.20308454887197,
                            141.7724552603926
                        ]
                    }
                ]
            }
        ],
        "options": {
            "maxRandomnessOffset": 2,
            "roughness": 1,
            "bowing": 1,
            "stroke": "#000",
            "strokeWidth": 1,
            "curveTightness": 0,
            "curveFitting": 0.95,
            "curveStepCount": 9,
            "fillStyle": "hachure",
            "fillWeight": -1,
            "hachureAngle": -41,
            "hachureGap": -1,
            "dashOffset": -1,
            "dashGap": -1,
            "zigzagOffset": -1,
            "seed": 0,
            "disableMultiStroke": false,
            "disableMultiStrokeFill": false,
            "preserveVertices": false,
            "randomizer": {
                "seed": 0
            }
        }
    },
    "width": 1,
    "strokeColor": "#000"
}


exports.create = (req, res) => {
    Drawing.updateOne(
        { boardId: req.body.whiteboardId },
        { $push: { data: req.body.elements } })
        .then(data => {
            var resp = {
                message: data.modifiedCount ? "Data updated" : "Could not add to database"
            }
            res.status(200).send(resp)
        })
        .catch(error => {
            res.status(500).send({
                message: error.message || "Could not add to database. Internal Error"
            })
        })
}

exports.load = (req, res) => {
    Drawing.findOne(
        { boardId: req.query.whiteboardId }
    )
        .then(data => {
            if (!data) {
                res.status(404).send({ data: data.data, message: `Whiteboard data not found in database` })
            }
            else {
                var elements = data.data
                if (elements.length > 0) {
                    res.status(200).send({ data: elements, message: `Data found in database` })
                }
                else {
                    res.status(200).send({ data: elements, message: `Whiteboard data not found in database` })
                }
            }
        })
        .catch(error => {
            res.status(500).send({
                message: error.message || "Cannot retrieve data. Internal Error"
            })
        })
}

exports.sync = (req, res) => {
    Drawing.findOne(
        { boardId: req.query.whiteboardId }
        // { boardId: req.query.whiteboardId, 'data.id': { $gt: 1,  $lte: 3 } },
        // { boardId: req.query.whiteboardId, "data.id": { $eq: 1 } },
        // {_id:0, data: true}
    )
        .then(data => {
            var subDrawingData = []
            let a = data.data
            let b = req.query.idList
            let n = a.length;
            let m = b.length;

            for (let i = 0; i < n; i++) {
                let j;

                for (j = 0; j < m; j++)
                    if (a[i].id == parseInt(b[j]))
                        break

                if (j == m)
                subDrawingData.push(a[i])    
            }

            res.status(200).send({ drawing: subDrawingData, message: subDrawingData.length>0 ? 'New data present' : 'No new data' })

        })
        .catch(err => {
            res.status(500).send({
                message:
                    err.message || "Some error occurred while retrieving tutorials."
            })
        })

    // var drawingData = []
    // drawingData.push(data)
    // res.status(200).send({ drawing: drawingData, message: 'HEllo' })
}

exports.loadif = (req, res) => {
    res.send(data)
}
